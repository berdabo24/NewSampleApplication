@page "/"
@using BlazorApp2.Services
@inject AiService Ai

<PageTitle>Home</PageTitle>

<div class="p-4">
    <h1 class="mb-1">No Sleep – AI Agentic Sample Application</h1>
    <p class="text-muted mb-4">
        A simple demo app showing Agentic AI features using our existing AI service.
    </p>

    <div class="row g-3">
        <!-- AI Chat -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">AI Chat</h5>
                    <p class="card-text text-muted">
                        General chat to test prompts and get explanations or drafts.
                    </p>
                    <a class="btn btn-primary w-100 mt-auto" href="ai">Open AI Chat</a>
                </div>
            </div>
        </div>

        <!-- Goal Counter -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Goal Counter (Agentic)</h5>
                    <p class="card-text text-muted">
                        Tell the AI your goal. It decides the target, step size, and milestones.
                    </p>
                    <a class="btn btn-primary w-100 mt-auto" href="counter">Open Goal Counter</a>
                </div>
            </div>
        </div>

        <!-- Schedule Assistant -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Schedule Assistant (Agentic)</h5>
                    <p class="card-text text-muted">
                        The AI proposes time options and generates a Google Calendar event link.
                    </p>
                    <a class="btn btn-primary w-100 mt-auto" href="calendar-agent">Open Schedule Assistant</a>
                </div>
            </div>
        </div>

        <!-- Email Assistant -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Email Assistant (Agentic)</h5>
                    <p class="card-text text-muted">
                        The AI drafts subject + email body, then your app opens the email client to send.
                    </p>
                    <a class="btn btn-primary w-100 mt-auto" href="email-agent">Open Email Assistant</a>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4" />

    <div class="alert alert-info mb-0">
        <b>How this is “Agentic AI”:</b>
        our AI makes decisions (planning, generating options, drafting content) and our app executes actions
        (tracking progress, opening Google Calendar event creation, opening email client to send).
    </div>
</div>

<div class="secret-trigger" @onclick="HandleSecretClick"></div>

@if (showDiagnostics)
{
    <div class="api-status-card">
        <div class="status-header">
            <small>System Status</small>
            <button class="btn btn-sm btn-close" @onclick="CloseDiagnostics"></button>
        </div>

        <div class="status-grid">
            @if (isChecking)
            {
                <div class="text-center p-2 text-muted">
                    <span class="spinner-border spinner-border-sm"></span> Checking...
                </div>
            }
            else
            {
                @foreach (var status in AiService.ApiStatus.OrderBy(x => x.Key))
                {
                    <div class="status-item">
                        <span>@status.Key.Replace("Groq-", "")</span>
                        <span>@(status.Value ? "✅" : "❌")</span>
                    </div>
                }

                <div class="mt-2 text-center">
                    <button class="btn btn-sm btn-outline-primary py-0" style="font-size: 0.75rem" @onclick="RunManualCheck">
                        Refresh Status
                    </button>
                </div>
            }
        </div>
    </div>
}

<style>
    /* Invisible Hitbox */
    .secret-trigger {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 80px;
        height: 80px;
        z-index: 9999;
        cursor: default;
    }

    /* The Popup Panel */
    .api-status-card {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        font-family: monospace;
        min-width: 160px;
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        font-size: 0.85rem;
        border-bottom: 1px solid #eee;
    }

    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 8px;
    }
</style>

@code {
    // --- Secret Menu Logic ---
    private int secretClickCount = 0;
    private bool showDiagnostics = false;
    private bool isChecking = false;

    private async Task HandleSecretClick()
    {
        secretClickCount++;
        // REQUIREMENT: 5 Consecutive Presses to unlock
        if (secretClickCount >= 5)
        {
            showDiagnostics = true;
            secretClickCount = 0; // Reset count
            await RunManualCheck(); // Auto-check on open
        }
    }

    private async Task RunManualCheck()
    {
        if (isChecking) return; // Prevent double-clicking

        isChecking = true;
        StateHasChanged();

        // Artificial delay so you can see the spinner (optional UI polish)
        await Task.Delay(300);

        // Call the service
        await Ai.CheckHealthAsync();

        isChecking = false;
    }

    private void CloseDiagnostics()
    {
        showDiagnostics = false;
        secretClickCount = 0;
    }
}

