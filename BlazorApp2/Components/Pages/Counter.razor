@page "/counter"
@using System.Text.RegularExpressions
@inject BlazorApp2.Services.AiService Ai

<PageTitle>Agentic Counter</PageTitle>

<h1>Agentic Counter</h1>

<p class="text-muted">
    This counter becomes agentic when the AI sets a goal + rules, and the app executes the counting plan.
</p>

<hr />

<h5>1) Tell the AI what you are counting</h5>

<div class="mb-3">
    <label class="form-label">Goal / context</label>
    <input class="form-control" @bind="goalPrompt"
           placeholder="E.g., I want to drink 8 glasses of water today. Help me set a counter plan." />
</div>

<button class="btn btn-primary" @onclick="GeneratePlan" disabled="@isBusy">
    @(isBusy ? "Generating..." : "Generate Counter Plan")
</button>

@if (!string.IsNullOrWhiteSpace(planRaw))
{
    <div class="mt-3">
        <h6>AI Plan (Decision Output)</h6>
        <pre class="p-3 border rounded bg-light">@planRaw</pre>
    </div>
}

@if (hasPlan)
{
    <hr />

    <h5>2) Track progress</h5>

    <p role="status">
        Current: <b>@currentCount</b> / <b>@target</b>
        (@progressPercent%)
    </p>

    <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-success" @onclick="Increment" disabled="@isBusy">
            +@step
        </button>

        <button class="btn btn-outline-secondary" @onclick="Decrement" disabled="@isBusy">
            -@step
        </button>

        <button class="btn btn-outline-danger" @onclick="Reset" disabled="@isBusy">
            Reset
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(agentMessage))
    {
        <div class="alert alert-info mt-3">@agentMessage</div>
    }
}

@code {
    private string goalPrompt = "";
    private bool isBusy = false;

    // AI decision output (plan)
    private string planRaw = "";
    private bool hasPlan = false;

    // Counter state
    private int currentCount = 0;

    // Plan variables decided by the AI
    private int target = 10;
    private int step = 1;
    private int[] milestones = Array.Empty<int>(); // e.g., [25,50,75,100]
    private string agentMessage = "";

    private int progressPercent => target <= 0 ? 0 : Math.Min(100, (int)Math.Round(currentCount * 100.0 / target));

    private async Task GeneratePlan()
    {
        isBusy = true;
        planRaw = "";
        agentMessage = "";
        hasPlan = false;
        currentCount = 0;

        var prompt = $@"
[SYSTEM]
You are a logic engine for a counter app.
From the user's goal, extract the numbers needed to track it.

[RULES]
- Return ONLY plain text. NO Markdown (**).
- Output must be in this EXACT format:

Target: <integer only>
Step: <integer only>
Milestones (%): <integers separated by commas>
Message: <short encouraging phrase>

[USER GOAL]
{goalPrompt}
";

        planRaw = await Ai.AskAsync(prompt);

        // Parse the AI plan (simple + robust)
        var parsed = ParsePlan(planRaw);
        if (parsed != null)
        {
            target = parsed.Value.Target;
            step = parsed.Value.Step;
            milestones = parsed.Value.Milestones;
            agentMessage = parsed.Value.Message;
            hasPlan = true;
        }
        else
        {
            agentMessage = "I couldn't parse the plan. Try a simpler goal sentence.";
        }

        isBusy = false;
    }

    private void Increment()
    {
        currentCount = Math.Min(target, currentCount + step);
        CheckMilestones();
    }

    private void Decrement()
    {
        currentCount = Math.Max(0, currentCount - step);
        agentMessage = "";
    }

    private void Reset()
    {
        currentCount = 0;
        agentMessage = "Reset done. Letâ€™s go again ðŸ’ª";
    }

    private void CheckMilestones()
    {
        if (milestones.Length == 0) return;

        var p = progressPercent;

        if (milestones.Contains(p))
        {
            agentMessage = $"Nice! You reached {p}% of your goal.";
        }

        if (p == 100)
        {
            agentMessage = "Goal achieved âœ… Great job!";
        }
    }

    private static (int Target, int Step, int[] Milestones, string Message)? ParsePlan(string text)
    {
        // Helper: "Loose" matching that ignores Markdown bolding (**)
        static string Get(string label, string input)
        {
            // Pattern: Start of line -> optional * -> Label -> optional * -> optional : -> Value
            var pattern = $@"(?im)^\s*[*]*{Regex.Escape(label)}[*]*[:]*\s*(.+)$";
            var m = Regex.Match(input, pattern);
            return m.Success ? m.Groups[1].Value.Trim() : "";
        }

        // Helper: Extract the first integer found in a string (e.g. "10 glasses" -> 10)
        static int ParseInt(string input, int fallback = -1)
        {
            var match = Regex.Match(input, @"\d+");
            return match.Success && int.TryParse(match.Value, out var val) ? val : fallback;
        }

        // 1. Extract Raw Strings
        // Note: We search for "Target" without the colon, let regex handle the colon
        var targetStr = Get("Target", text);
        var stepStr = Get("Step", text);
        var mileStr = Get("Milestones (%)", text); // Or just "Milestones"
        if (string.IsNullOrEmpty(mileStr)) mileStr = Get("Milestones", text); // Fallback
        var msg = Get("Message", text);

        // 2. Parse Numbers (Robustly)
        var t = ParseInt(targetStr);
        var s = ParseInt(stepStr);

        // If Target or Step are missing/invalid, fail gracefully
        if (t <= 0 || s <= 0) return null;

        // 3. Clamp logic
        t = Math.Clamp(t, 1, 100000);
        s = Math.Clamp(s, 1, 100000);

        // 4. Parse Milestones
        var miles = mileStr
            .Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries) // Split by comma OR space
            .Select(x => ParseInt(x)) // Parse "25%" -> 25
            .Where(v => v >= 1 && v <= 100)
            .Distinct()
            .OrderBy(v => v)
            .ToArray();

        // 5. Default Message
        if (string.IsNullOrWhiteSpace(msg)) msg = "Letâ€™s go!";

        return (t, s, miles, msg);
    }
}
